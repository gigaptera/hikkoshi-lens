## 1. システム概要

### プロジェクト名

**Hikkoshi Lens (仮)**

### アーキテクチャ方針

- **Go言語を中心としたBFF（Backend For Frontend）構成**。
    
- フロントエンド（Next.js）でのリアルタイム計算を重視し、UXを最適化する。
    
- インフラはGoogle Cloudのマネージドサービスをフル活用し、**「コンテナ実行」「機密情報管理」「画像配信」**の責務を分離する。
    
- Pythonは「オプション」とし、必須としない（高度な解析が必要になった場合のみマイクロサービスとして追加）。
    

## 2. 技術スタック選定

|**レイヤー**|**技術・ツール**|**役割・選定理由**|
|---|---|---|
|**Frontend**|**Next.js (App Router)**|地図（Mapbox）制御、総合スコアのリアルタイム計算（重み付け）。|
|**Map Library**|**Mapbox GL JS**|3D表示、カスタムピン、高速なベクター描画。|
|**Backend (Main)**|**Go** (Echo / Gin 等)|**API Gateway兼ロジック担当**。<br><br>  <br><br>通勤時間計算、DB操作、認証、バリデーション。|
|**Database**|**Supabase (PostgreSQL)**|**PostGIS拡張**を利用し、半径検索等の空間演算を高速処理。<br><br>  <br><br>※DB機能のみ利用し、Storage等の機能はGCPへ寄せる。|
|**Compute**|**Google Cloud Run**|**コンテナベースのフルマネージドな実行環境**。<br><br>  <br><br>オートスケール、運用負荷の低さ、Go/Next.jsコンテナとの相性の良さから選定。|
|**Object Storage**|**Google Cloud Storage**|**画像・静的アセットの保存**。<br><br>  <br><br>駅周辺写真やユーザーデータの保存先。Cloud Runと同一ネットワークでIAM統合が可能。|
|**Security**|**Secret Manager**|**機密情報管理**。<br><br>  <br><br>DB接続文字列、Mapbox API Key等を管理し、デプロイ時に環境変数として注入する。|
|**CI/CD & Registry**|**Cloud Build** / **Artifact Registry**|**ビルド・デプロイパイプライン**。<br><br>  <br><br>GitHubへのPushをトリガーにコンテナをビルドし、Registryへ格納・Deployを行う。|
|**Observability**|**Cloud Logging**|**ログ・監視**。<br><br>  <br><br>構造化ログ(JSON)によるエラー追跡とパフォーマンス監視。|

## 3. アーキテクチャ設計図

コード スニペット

```
graph TD
    User[User / Browser]
    
    subgraph Google_Cloud_Platform
        subgraph DevOps
            AR[Artifact Registry<br>(Docker Images)]
            CB[Cloud Build<br>(CI/CD)]
        end

        subgraph Compute_Runtime
            Next[Cloud Run<br>Frontend (Next.js)]
            Go[Cloud Run<br>Backend (Go)]
        end
        
        subgraph Managed_Services
            GCS[Cloud Storage<br>(Images/Assets)]
            SM[Secret Manager<br>(API Keys/DB URL)]
            Log[Cloud Logging<br>(Logs/Metrics)]
        end
    end
    
    subgraph External_Services
        DB[(Supabase / PostGIS)]
        Map[Mapbox API]
    end

    %% User Flow
    User -- "1. Access / Interaction" --> Next
    Next -- "2. API Request" --> Go
    
    %% Backend Logic
    Go -- "3. Fetch Secrets (Startup)" --> SM
    Go -- "4. Query Data" --> DB
    Go -- "5. Read/Write Images" --> GCS
    Go -- "6. Log Output" --> Log
    
    %% Frontend Logic
    Next -- "Map Rendering" --> Map
    Next -- "Realtime Score Calc" --> Next
    
    %% Build Flow
    CB -- "Push Image" --> AR
    AR -- "Deploy" --> Next
    AR -- "Deploy" --> Go
```

## 4. インフラ・データ責務分担

### Google Cloud 担当領域

- **実行環境 (Compute)**: アプリケーションコードの実行 (Cloud Run)。
    
- **静的リソース (Asset)**: 画像ファイル等の永続化 (Cloud Storage)。
    
- **セキュリティ (Security)**: APIキーやDBパスワードの安全な管理 (Secret Manager)。
    
- **運用 (Ops)**: ログ収集とデプロイメントパイプライン (Logging / Cloud Build)。
    

### Supabase 担当領域

- **構造化データ (RDB)**: ユーザー情報、物件・駅のマスタデータ。
    
- **空間演算 (GIS)**: 位置情報に基づいた検索ロジック (PostGIS)。
    
